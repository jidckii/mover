#!/bin/bash
log_daemon=/opt/mover/log/daemon.log

dirmake=/home/mover/queue-video-tmp/
mediapath=/media

text1="Обнаружен USB носитель, с данными объемом "
text2="USB носитель отсутствует"
text3="видео файлов найдено, в формате"
text4="Введите ИМЯ для инджестируемого материала:"
text5="Отсутствует видео в формате .MP4 или .MTS , проверьте USB носитель на PC"
text6="Копирование завершено, извлеките USB носитель !!!"
text7="Идет копирование ..."

# Заходим в цикл и работаем как бы в режиме демона
while true; do 
	sleep 5
	usbsizenum=`du -s $mediapath | awk '{print $1}'`
	usbsizehum_num=`du -s -h $mediapath | awk '{print $1}'`

# Если размер каталога меньше 1 мегабайта, начинаем цикл заново.
	if [ "$usbsizenum" -lt "1000" ]; then
		continue
	fi

	echo -e '\n' "\e[0;32m $text1 \e[0;35m $usbsizehum_num \e[0m" '\n'
	worklist_mp4=`find $mediapath -name *.MP4 | wc -l`
	worklist_mts=`find $mediapath -name *.MTS | wc -l` 

# Если файлов в формате по маске не обнаружено, начинаем цикл заново.
	if [ "$worklist_mp4" -eq "0" -a "$worklist_mts" -eq "0" ]; then
		echo -e '\n' "\e[0;31m $text5 \e[0m" '\n'
		continue
	fi

	if [ "$worklist_mp4" -gt "0" ]; then
		echo -e '\n' "\e[0;35m $worklist_mp4 \e[0;32m $text3 \e[0;35m MP4 \e[0m" '\n'
		echo -e '\n' "\e[1;33m $text4 \e[0m" '\n'
		read dir_name
		mkdir -p $dirmake$dir_name
		echo -e '\n' "\e[1;32m $text7 \e[0m" '\n'
		find $mediapath -name "*.MP4" -print0 | xargs -0 cp --target-directory=$dirmake$dir_name
	elif [ "$worklist_mts" -gt "0" ]; then
		echo -e '\n' "\e[0;35m $worklist_mts \e[0;32m $text3 \e[0;35m MTS \e[0m" '\n'
		echo -e '\n' "\e[1;33m $text4 \e[0m" '\n'
		read dir_name
		mkdir -p $dirmake$dir_name
		echo -e '\n' "\e[1;32m $text7 \e[0m" '\n'
		find $mediapath -name "*.MTS" -print0 | xargs -0 cp --target-directory=$dirmake$dir_name
	fi

	echo -e '\n' "\e[4;32m $text6 \e[0m" '\n'
	sleep 5
	usbsizeend=`du -s $mediapath | awk '{print $1}'`

# ждем извлечения USB.
	while [ "$usbsizeend" -eq "$usbsizenum" ]; do
		# echo -e '\n' "\e[4;32m $text6 \e[0m" '\n'	
		sleep 2
		usbsizeend=`du -s $mediapath | awk '{print $1}'`
		# usbsizeendnum=`cat $usbsizeend`

		if [ "$usbsizeend" -ne "$usbsizenum" ];  then
			echo -e '\n' "\e[4;32m $text2 \e[0m" '\n'
			break					
		fi

	done 
done
